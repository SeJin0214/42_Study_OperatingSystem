# 멀티프로세서 스케줄링

>여러 CPU에 작업을 어떻게 스케줄 해야 하는가?

문제를 해결하기 위해서는 응용프로그램을 병렬로 실행되도록 다시 작성해야 한다.  

## 배경 : 멀티프로세서 구조

단일 CPU의 시스템에는 하드웨어 캐시 계층 존재  
>캐시 : 데이터의 복사본을 저장하는 작고 빠른 메모리이다. 

단순하게 생각해서 프로세스가 읽은 데이터를 캐시에 저장 다음번에 메모리에 접근 하지 않고  
바로 캐시로 가서 데이터를 빠르게 읽고 처리한다.  
문제점 단일 cpu에서는 캐시는 하나 만약 여러개의 cpu(캐시가 여러개???)에서는 어떻게 대응하지?  
버스 스누핑
* 캐쉬 데이터에 대한 변경이 발생시 자신의 복사본을 무효화 시키거나 갱신한다.
>캐시 일관성 문제  
>CPU가 여러개에서 프로세스가 다른 CPU로 이동시 하고 접근시 캐시는 다른데이터를 가지고 있다.  
즉 읽어야하는 데이터가 아니라 다른 데이터를 가지고 온다.  

## 동기화를 잊지 마시오
>병행성 공부가 필요하다.

프로그램 또는 운영체제 자신은 공유데이터를 접근할 때 걱정할 필요가 있다.  
CPU들이 동일한 데이터 또는 구조체에 접근하기 위해서 다양한 기법이 사용된다.  
lock-free기법이 있다.  
병행성이 중요하다.  

## 마지막 문제점 : 캐시 친화성
프로세스는 동일한 cpu에서 실행되는것이 유리하다. -> 해당 cpu에 캐시가 저장되어 있기때문에 실행이 빠르게  
될 것이다. 멀티프로세서 스케줄러는 스케줄링 결정을 내릴 때 캐시친화성을 고려해야한다.  
생각을 해면 당연하다.  
군대에서 병사가 취사병도 했다가 다음날에는 기관총 사수도 했다가 군종병도 하면 계속 프로토콜이 바뀌고,  
업무 수행 능력이 느려진다.  
내 이야기는 절대 아니다.  

## 단일 큐 스케줄링

SQMS 는 한개의 큐에서 프로세스들이 cpu를 이동해간다. 단점은 확장성이 결여되어 있다.  
다수의 cpu에서 제대로 동작하게 하기 위해 코드에 일정 형태의 락 삽입 -> 성능저하  
캐시 친화성 이 낮다.  
단일 큐에서 다수의 cpu를 이동하기 때문에 캐시친화성이 낮지만 대부분의 sqms에서는 단일 프로세스가  
동일한 cpu에서 작동하도록 하게 만든다.  
하지만 구현이 복잡해 질 수 있다.  

## 멀티 큐 스케줄링

MQMS 여러 개의 크케줄링 큐로 구성된다.  
어떤 스케줄링 기법도 사용 가능  
장점  
*확장성이 좋다.  
*캐시 친화적이다.  

단점 워크로드의 불균형  
왜냐 ??? 큐가 두개에서 각각 2개의 프로세스가 돌아간다. 근데 첫번째 큐의 프로세스한개가 먼저 끝나서  
나머지 한개의 프로세스가 cpu를 독점한다. 이기 적일 수가 없다.  
또한 나머 지 한개 마저 작업이 끝난다면 cpu는 놀게 된다.  
이러한 불공정을 막기 위해  
* 이주 : 를 사용 해서 프로그램을 이리 저리 이주 시킨다.  
하지만 문제도 있다. 어떻게 이주여부를 결정할까?  그중 한가지 방법은 작업 훔치기 이다.  
작업 갯수를 확인해서 조정 하는 방식이다.  근데 검사 횟수는 어떻게 결정할까???  
적절한 횟수를 구하는건 매우 어렵다.  


## linux 멀티프러세서 스케줄러
O : 멀티큐  
CFS : 멀티 큐  
BFS : 단일 큐  

##

##

##