# 주소 변환의 원리
<strong>어떻게 효율적이고 유연하게 메모리를 가상화하는가?</strong><br>
##### 하드웨어-기반 주소 변환(hardware-based address translation) = 주소변환(address translation)<br>
: 하드웨어와 os가 협력하여 하드웨어는 가상 주소를 정보가 실제 존재하는 물리 주소로 변환 <br>
목표: 프로그램이 자신의 전용 메모리를 소유하고 그 안에 자신의 코드와 데이터가 있다는 환상 만들기

## 18.1 가정
1. 사용자 주소 공간은 물리 메모리에 연속적으로 배치되어야 한다고 가정
2. 주소 공간의 크기가 너무 크지 않다고 가정(주소 공간은 물리 메모리 크기보다 작음)
3. 각 주소 공간의 크기는 같다고 가정

## 18.2 사례
```c
void func() {
int x = 3000;
x = x + 3;

128: movl 0x0(\%ebx) , \%eax ; // 0+ebx를 eax에 저장
132: addl \$0x03, \%eax ; //eax레지스터에 3을 더한다
135: movl \%eax, 0x0(\%ebx) ; //eax를 메모리에 다시 저장
```

<a href="https://imgbb.com/"><img src="https://i.ibb.co/yWDLVXQ/Screenshot-from-2024-07-31-23-31-44.png" alt="Screenshot-from-2024-07-31-23-31-44" border="0"></a>

timeline
- 주소 128의 명령어를 반입
- 이 명령어 실행(주소 15KB에서 탑재)
- 주소 132의 명령어를 반입
- 이 명령어 실행(메모리 참조 없음)
- 주소 135의 명령어를 반입
- 이 명령어 실행 (15KB에 저장)

## 18.3 동적 (하드웨어 - 기반) 재배치
<strong>베이스와 바운드(base and bound)</strong>: 1950년대 채택된 아이디어 <br>
각 CPU마다 베이스 레지스터, 바운드 레지스터(= 한계 레지스터)라는 2개의 하드웨어 레지스터가 필요함. <br>
베이스 바운드 레지스터의 역할: 
- 원하는 위치에 주소 공간 배치
- 프로세스가 오직 자신의 주소 공간에만 접근한다는 것 보장
프로그램 시작 시 운영체제는 프로그램이 탑재될 물리 메모리 위치를 결정하고 베이스 레지스터를 그 주소로 지정.

<a href="https://imgbb.com/"><img src="https://i.ibb.co/XF1c7nJ/Screenshot-from-2024-07-31-23-48-50.png" alt="Screenshot-from-2024-07-31-23-48-50" border="0"></a>

32KB에 저장된 경우 <br>

```c
physical address = virtual address + base
```
프로세스가 생성하는 가상주소 + 베이스 레지스터의 내용을 이 주소에 더하여 물리 주소 생성 <br>
이 주소의 재배치는 실행 시에 일어나고, 프로세스가 실행한 이후에도 이동 가능하기에 동적 재배치로도 불림. <br>
바운드 레지스터는 보호를 지원하기 위해 존재. 프로세서는 메모리 참조를 위해 가상 주소가 바운드 안에 있는지 확인.바운드보다 큰 가상 주소나 음수인 가상 주소를 참조하면 예외 발생, 프로세스 종료 <br>
바운드 레지스터의 방식
1. 주소 공간의 크기를 저장하는 방식
2. 주소 공간의 마지막 물리 주소를 저장하는 방식

## 18.4 하드웨어 지원: 요약
|하드웨어 요구 사항|노트|
|------|---|
|특권 모드|사용자 모드 프로세스가 특권 연산을 실행하는 것을 방지하기 위해 필요|
|베이스/바운드 레지스터|주소 변환과 범위 검사를 지원하기 위하여 CPU 당 한 쌍의 레지스터가 필요|
|가상 주소를 변환하고 범위 안에 있는지 검사하는 능력|주소 변환과 범위 검사를 위한 회로|
|베이스/바운드를 갱신하기 위한 특권 명령어|프로그램 시작 전에 운영체제가 베이스와 바운드 레지스터 값을 지정할 수 있어야 함|
|예외 핸들러 등록을 위한 특권 명령어|운영체제가 예외 처리 코드를 하드웨어에게 알려줄 수 있어야 함|
|예외 발생 기능|프로세스가 특권 명령어 실행을 시도하거나 범위를 벗어난 메모리의 접근을 시도할 때 예외를 발생시킬수 있어야 함|

## 18.5 운영체제 이슈
1. 프로세스가 생성될 때 운영체제는 주소 공간이 저장될 메모리 공간을 free list에서 찾아 조치를 취해야 함.
2. 프로세스가 종료될 때 메모리를 다시 free list에 넣어 재사용할 수 있게 해야함
3. 문맥교환이 일어날 때 베이스와 바운드 쌍을 저장하고 복원해야 함. (process structure = process control block)
<a href="https://ibb.co/wwj5pG9"><img src="https://i.ibb.co/3MQgS6D/Screenshot-from-2024-08-01-02-48-51.png" alt="Screenshot-from-2024-08-01-02-48-51" border="0"></a>

4. 예외 발생 시 예외 핸들러 또는 호출될 함수 제공해야 함